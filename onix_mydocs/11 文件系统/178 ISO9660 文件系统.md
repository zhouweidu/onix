# ISO9660 文件系统

ISO9660 [^iso-9660] 是 CD-ROM 的标准文件系统。它也被广泛用于 DVD 和 BD(Blu-ray) [^blu-ray] 媒体，也可以出现在 U 盘或硬盘上。其规格可在 ECMA-119 的名称下免费获得。

## 概述

ISO 9660 并不是一个复杂的文件系统，但是有一些特殊之处值得注意。似乎有些操作系统会创建不兼容的 CD，所以要小心！这方面的主要例子是文件名可用的字符集。严格来说，文件名只能由大写字母A-Z、数字、点和下划线组成。此外，还有一个分号将可见的文件名与其版本号后缀分隔开。许多操作系统也允许小写字母和其他字符。Linux 的 VFS 向用户显示小写的文件名，尽管 CD 内容实际上包含大写字符。

## 扇区大小

ISO 9660 扇区大小通常为 2KB。尽管该规范允许选择扇区大小，但除了 2KB 之外，很少能找到其他扇区大小。

## 数值格式

该系统的另一个特点是它有几种编号格式，多字节数字通常以两端格式(both-endian) 表示。ISO 9660 标准指定了三种编码 16 位和 32 位整数的方法，使用小端序(little-endian)、大端序(big-endian) 或两者的组合(小端序后大端序)。因此，两端字段(LSB-MSB) 的宽度是原来的两倍。因此，32 位的 LBA 通常显示为 8 字节字段。当出现两端序格式时，x86 架构使用第一个小端序，而忽略大端序。

| 编码           | 描述                                   |
| -------------- | -------------------------------------- |
| int8           | 无符号 8 位整数                        |
| sint8          | 有符号的 8 位整数                      |
| int16_LSB      | 小端编码无符号 16 位整数               |
| int16_MSB      | 大端编码无符号 16 位整数               |
| int16_LSB-MSB  | 小端数后跟大端数编码无符号 16 位整数   |
| sint16_LSB     | 小端编码有符号 16 位整数               |
| sint16_MSB     | 大端位数编码有符号 16 位整数           |
| sint16_LSB-MSB | 小端数后跟大端数编码有符号 16 位整数   |
| int32_LSB      | 小端数编码的 32 位无符号整数           |
| int32_MSB      | 大端数编码 32 位无符号整数             |
| int32_LSB-MSB  | 小端序后跟大端序编码的 32 位无符号整数 |
| sint32_LSB     | 小端编码 32 位有符号整数               |
| sint32_MSB     | 大端编码有符号 32 位整数               |
| sint32_LSB-MSB | 小端数后跟大端数编码有符号 32 位整数   |

## 日期/时间格式

主卷描述符 (Primary Volume Descriptor) 中使用的日期/时间格式被表示为 dec-datetime，并使用 ASCII 数字表示日期/时间的主要部分:

| 偏移 | 大小 | 类型 | 描述                        |
| ---- | ---- | ---- | --------------------------- |
| 0    | 4    | strD | 年: 1 ~ 9999                |
| 4    | 2    | strD | 月: 1 ~ 12                  |
| 6    | 2    | strD | 日: 1 ~ 31                  |
| 8    | 2    | strD | 时: 0 ~ 23                  |
| 10   | 2    | strD | 分: 0 ~ 59                  |
| 12   | 2    | strD | 秒: 0 ~ 59                  |
| 14   | 2    | strD | 百分秒: 0 ~ 99              |
| 16   | 1    | int8 | 时区(15分) 0(-48) ~ 100(52) |

注：时区与格林尼治标准时间的偏移间隔为 15 分钟，从间隔 -48(西) 开始，一直到间隔 52(东)。因此，值 0 表示间隔 -48，等于 GMT-12 小时，值 100 表示间隔 52，等于 GMT+13 小时。

除了与 GMT 的偏移量外，所有字段都是 ASCII 数字。当日期和时间未指定时，所有字符串字段都是 ASCII '0'(总共 16 个 ASCII 零)，最后一个字段是二进制零。

## 字符串格式

字符串使用 ASCII 编码进行编码。该规范不允许所有字符。它定义了两组字符: A字符组 和 D字符组。您将在本文的描述符表中看到这些术语。字符集是:

|         |                           |
| ------- | ------------------------- |
| A字符组 | A B C D E F G H I J K L   |
|         | M N O P Q R S T U V W X   |
|         | Y Z 0 1 2 3 4 5 6 7 8 9 _ |
|         | ! " % & ' ( ) * + ,       |
|         | - . / : ; < = > ?         |
| D字符组 | A B C D E F G H I J K L   |
|         | M N O P Q R S T U V W X   |
|         | Y Z 0 1 2 3 4 5 6 7 8 9 _ |

注意：并非所有 CD 都严格遵循 ISO 9660 中指定的字符集。

## 文件名

文件名必须使用 D字符编码(strD)，加上点和分号，每个文件名只能出现一次。文件名由一个文件名，一个点，一个文件扩展名，一个分号组成；以及十进制数字的版本号。后两者通常不会显示给用户。

这里定义了三个交换级别。1 级允许文件名长度为 8，扩展名长度为 3(如 MS-DOS)。第 2 级和第 3 级允许 **文件名** 和 **文件名扩展名** 的组合长度不超过 30 个字符。

ECMA-119 目录记录格式最多可以保存 222 个字符的组合名称。这将违反规范，但仍然必须由文件系统的读取器处理。

## 大小限制

ISO 9660 文件系统最多可以有 $2^{32}$ 块，即 8TB。通常情况下，它们将被限制在光学介质的大小。(目前高达 100 GB 与 4 层 BD-R。)

数据文件的最大大小取决于 ISO 文件系统的交换级别。级别 1 和 2 允许 4GB - 1($2^{32} - 1$)，因为单个目录记录可以要求最多这个字节数。级别 3 允许有多个同名的结果目录记录。它们都被连接到一个数据文件中。这意味着一个数据文件几乎可以填满整个 8TB 的镜像大小。

## 系统区域

ISO 9660 文件系统从 32 KB 开始，可用于任意数据。这通常用于存储引导信息，因为 ISO 9660 文件系统不是存储在光学介质上，而是存储在类似硬盘的设备上，例如 U 盘上。

因此，准备在该位置找到一个主引导记录(MBR，用于BIOS)，一个 GUID 分区表(GPT，用于EFI)，或一个 Apple 分区映射(APM)。

## 卷描述符

在准备挂载 CD 时，第一个操作将是读取卷描述符(具体地说，查找主卷描述符)。

由于 CD 的扇区 `0x00-0x0F`(32KB) 被保留为系统区，卷描述符可以从扇区 0x10(16) 开始找到。卷描述符的格式如下:

| 偏移 | 长度 | 名称   | 类型 | 描述                     |
| ---- | ---- | ------ | ---- | ------------------------ |
| 0    | 1    | 类型   | int8 | 卷描述符类型代码(见下文) |
| 1    | 5    | 标识符 | strA | 总是 `CD001`             |
| 6    | 1    | 版本   | int8 | 卷描述符版本(0x01)       |
| 7    | 2041 | 数据   | -    | 取决于卷描述符类型       |

这意味着每个卷描述符占一个扇区(2KB)的大小。

## 卷描述符类型码

以下为卷描述符类型表

| 值      | 描述             |
| ------- | ---------------- |
| 0       | 引导记录         |
| 1       | 主卷描述符       |
| 2       | 补充卷描述符     |
| 3       | 卷分区描述符     |
| 4 ~ 254 | 保留             |
| 255     | 卷描述符集结束符 |

当开始使用一个 CD 时，我们将对 **主卷描述符** 感兴趣，它指向 **根目录** 和 **路径表**，它们都允许我们找到 CD 上的任何文件。对于不希望逐个节点搜索目录层次结构的最小实现，使用路径表是理想的。这比较慢(在整个文件系统中进行字符串比较)，但更容易实现。

### 引导记录

卷描述符的第一种类型是 **引导记录**，在第 17(0x11) 个扇区（块），描述符格式如下:

| 偏移 | 长度 | 名称           | 类型 | 描述                                       |
| ---- | ---- | -------------- | ---- | ------------------------------------------ |
| 0    | 1    | 类型           | int8 | 卷描述符类型代码(见下文)                   |
| 1    | 5    | 标识符         | strA | 总是 `CD001`                               |
| 6    | 1    | 版本           | int8 | 卷描述符版本(0x01)                         |
| 7    | 32   | 引导系统标识符 | strA | 系统ID                                     |
| 39   | 32   | 引导标识符     | strA | 在此描述符的其余部分中定义的引导系统的标识 |
| 71   | 1977 | 引导系统使用   | -    | 用于引导系统                               |

最常见的引导系统使用规范是 El Torito [^El-Torito]。它将 El Torito 引导目录的块地址记录在字节 71 到 74 的小端位 32 位数字。这个目录列出了可用的引导映像，它们作为引导系统的起点。

### 主卷描述符

这是一个很长的描述符，在第 16(0x10) 个扇区（块），但是它包含了一些非常有用的信息，用于读取文件系统的其余部分。

| 偏移 | 长度 | 名称                | 类型          | 描述                             |
| ---- | ---- | ------------------- | ------------- | -------------------------------- |
| 0    | 1    | 类型                | int8          | 卷描述符类型代码(见下文)         |
| 1    | 5    | 标识符              | strA          | 总是 `CD001`                     |
| 6    | 1    | 版本                | int8          | 卷描述符版本(0x01)               |
| 7    | 1    | 未使用的            | -             | 总是 0                           |
| 8    | 32   | 系统标识符          | strA          | 见下文                           |
| 40   | 32   | 卷标识符            | strD          | 该卷的标识。                     |
| 72   | 8    | 未使用              | -             | 所有的0。                        |
| 80   | 8    | 卷空间大小          | int32_LSB-MSB | 记录卷的逻辑块个数。             |
| 88   | 32   | 未使用              | -             | 所有的0。                        |
| 120  | 4    | 卷集大小            | int16_LSB-MSB | 此逻辑卷中的集合大小(磁盘数)。   |
| 124  | 4    | 卷序列号            | int16_LSB-MSB | 卷集中该磁盘的编号。             |
| 128  | 4    | 逻辑块大小          | int16_LSB-MSB | 见下文                           |
| 132  | 8    | 路径表大小          | int32_LSB-MSB | 路径表的大小，以字节为单位。     |
| 140  | 4    | L型路径表的位置     | int32_LSB     | 见下文                           |
| 144  | 4    | 可选L型路径表的位置 | int32_LSB     | 见下文                           |
| 148  | 4    | M型路径表的位置     | int32_MSB     | 见下文                           |
| 152  | 4    | 可选M型路径表的位置 | int32_MSB     | 见下文                           |
| 156  | 34   | 根目录的目录入口    | -             | 见下文                           |
| 190  | 128  | 卷集标识符          | strD          | 卷是其成员的卷集标识符。         |
| 318  | 128  | 出版商标识符        | strA          | 见下文                           |
| 446  | 128  | 数据准备标识符      | strA          | 见下文                           |
| 574  | 128  | 应用标识符          | strA          | 见下文                           |
| 702  | 37   | 版权文件标识符      | strD          | 见下文                           |
| 739  | 37   | 摘要文件标识符      | strD          | 见下文                           |
| 776  | 37   | 书目文件标识符      | strD          | 见下文                           |
| 813  | 17   | 卷创建日期和时间    | dec-datetime  | 创建卷的日期和时间。             |
| 830  | 17   | 卷修改日期和时间    | dec-datetime  | 卷被修改的日期和时间。           |
| 847  | 17   | 卷过期日期和时间    | dec-datetime  | 见下文                           |
| 864  | 17   | 卷生效日期和时间    | dec-datetime  | 见下文                           |
| 881  | 1    | 文件结构版本        | int8          | 目录记录和路径表版本(总是0x01)。 |
| 882  | 1    | 未使用的            | -             | 总是 0                           |
| 883  | 512  | 应用程序使用        | -             | ISO 9660 中未定义的内容。        |
| 1395 | 653  | 保留                | -             | 由 ISO 保留                      |


- 系统标识符：可以对卷的扇区 0x00-0x0F 起作用的系统的名称 
- 逻辑块大小：这意味着 CD 上的逻辑块可能不是 2KB
- L型路径表的位置：路径表的 LBA 位置。所指向的路径表只包含小端序值；
- 可选L型路径表的位置：可选路径表的 LBA 位置。所指向的路径表只包含小端序值。0 表示不存在可选路径表
- M型路径表的位置：路径表的 LBA 位置，所指向的路径表只包含大端值
- 可选M型路径表的位置：可选路径表的 LBA 位置，所指向的路径表只包含大端值，0 表示不存在可选路径表
- 根目录的目录入口：注意，这不是一个 LBA 地址，它是实际的目录记录，其中包含一个单字节的目录标识符(0x00)，因此固定的 34 字节大小
- 出版商标识符：对于扩展发布者信息，第一个字节应该是0x5F，后面跟着根目录中文件的文件名，如果没有指定，所有字节都应该是0x20
- 数据准备标识符：为该卷准备数据的人员的标识符，对于扩展准备信息，第一个字节应该是 0x5F，后面跟着根目录中文件的文件名。如果没有指定，所有字节都应该是 0x20
- 应用标识符： 标识数据是如何记录在这个卷上的。对于扩展信息，第一个字节应该是 0x5F，后面跟着根目录中文件的文件名。如果没有指定，所有字节都应该是 0x20
- 版权文件标识符：根目录中包含此卷集的版权信息的文件的文件名。如果没有指定，所有字节都应该是 0x20
- 摘要文件标识符：根目录中包含此卷集的摘要信息的文件的文件名。如果没有指定，所有字节都应该是 0x20
- 书目文件标识符：根目录中包含此卷集书目信息的文件的文件名。如果没有指定，所有字节都应该是 0x20(空格)
- 卷过期日期和时间：本卷被认为过期的日期和时间如果没有指定，那么卷永远不会被认为是过时的
- 卷生效日期和时间：卷可以被使用的日期和时间，如果不指定，则可以立即使用卷

### 卷描述符集结束符

卷描述符集结束符目前没有定义其卷描述符的 7-2047 字节。这意味着卷集结束符使用的唯一字段是类型代码(255)、标准标识符('CD001')和描述符版本(0x01)。

### 路径表

路径表包含一个有序的记录序列，描述 CD 上的每个目录范围。有一些例外：由于 **父目录号** 字段的长度，路径表只能包含 65536 条记录。如果光盘上有超过这个数量的目录，一些 CD 创作软件将忽略这个限制并创建一个不兼容的CD(例如，这适用于一些早期版本的 Nero [^Nero])。如果您的文件系统使用路径表，您应该意识到这种可能性。Windows 使用路径表，对于这种不兼容的CD 将会失效(存在额外的节点，但显示为零字节)。使用目录表的 Linux 不受此问题的影响。

路径表的位置可以在主卷描述符中找到。有两种表类型：L型路径表(与x86相关) 和 M型路径表。这两个表之间的唯一区别是，L型是 LSB(Least Significant Bit)-first，而M型种是 MSB(Most Significant Bit)-first [^bit_numbering]。LSB 表示小端，MSB 表示大端。大小端的存储方式，描绘了二进制位在存储器中的组织方式。

路径表项的结构如下:

| 偏移 | 大小 | 描述                                   |
| ---- | ---- | -------------------------------------- |
| 0    | 1    | 目录标识符长度                         |
| 1    | 1    | 扩展属性记录长度                       |
| 2    | 4    | 区段位置(LBA)。这取决于它是L型 还是M型 |
| 6    | 2    | 父目录的目录号                         |
| 8    | 可变 | 以 D 字符表示的目录标识符(名称)         |
| 可变 | 1    | 填充字段                               |

注：

- 父目录的目录号：(路径表中的索引)。这个字段将表限制为 65536 条记录
- 填充字段：如果目录标识符字段的长度为奇数，则包含一个零，否则不存在。这意味着每个表项总是以偶数字节数开始。
- 路径表按照目录级别的升序排列，并在每个目录级别中按字母顺序排序。

### 目录

在从 ISO 9660 CD 中读取时，有时需要一个目录记录来定位文件，即使最初通常使用路径表来定位目录。与路径表不同的是，每个目录表只有一个版本，多字节数采用两端格式。每个目录将以 2 个特殊入口开始: 一个描述 `.` 入口的空字符串，以及描述 `..` 入口的字符串 `\1`，目录记录的布局如下:

| 偏移 | 大小 | 描述                                         |
| ---- | ---- | -------------------------------------------- |
| 0    | 1    | 目录记录的长度                               |
| 1    | 1    | 扩展属性记录长度                             |
| 2    | 8    | 两端格式的区段位置(LBA)                      |
| 10   | 8    | 两端格式的数据长度(范围大小)                 |
| 18   | 7    | 记录日期和时间(见下文)                       |
| 25   | 1    | 文件标志(见下文)                             |
| 26   | 1    | 以交错模式记录的文件的文件单位大小，否则为零 |
| 27   | 1    | 以交错模式记录的文件的交错间隙大小，否则为零 |
| 28   | 4    | 卷序列号：以 16 位双端格式记录此区段的卷     |
| 32   | 1    | 文件标识符(文件名)的长度：                   |
| 33   | 可变 | 文件标识符                                   |
| 可变 | 1    | 填充字段                                     |
| 可变 | 可变 | 系统使用                                     |

注：

- 文件标识符(文件名)的长度：它以一个 `;` 字符结束，后面跟着以 ASCII 编码的十进制 ('1') 表示的文件 ID 号；
- 填充字段：如果文件标识符长度为偶数，则填充字段为零，否则，该字段不存在。这意味着目录条目总是以偶数字节数开始。 
- 系统使用：最大记录大小 255 的剩余字节可用于 ISO 9660 的扩展。最常见的是系统使用共享协议(SUSP)及其应用，Rock Ridge 交换协议(RRIP)。

即使一个目录跨越多个扇区，目录入口也不允许跨越扇区边界(与路径表不同)。如果在扇区末尾没有足够的空间来记录整个目录条目，则该扇区是用零填充的，并使用下一个连续的扇区。上面的一些属性需要解释。不幸的是，日期/时间格式与主卷描述符中使用的格式不同。日期/时间格式为：

| 偏移 | 大小 | 描述                        |
| ---- | ---- | --------------------------- |
| 0    | 1    | 自 1900 年开始的年数        |
| 1    | 1    | 月: 1 ~ 12                  |
| 2    | 1    | 日: 1 ~ 31                  |
| 3    | 1    | 时: 0 ~ 23                  |
| 4    | 1    | 分: 0 ~ 59                  |
| 5    | 1    | 秒: 0 ~ 59                  |
| 6    | 1    | 时区(15分) 0(-48) ~ 100(52) |

这与包含 ASCII 编码的十进制值的 PVD(Primary Volume Descriptor) 形成了鲜明的对比，但这种格式可能用于节省大量条目的磁盘空间。

另一个需要解释的字段是 **文件标志** 字段。这是由一个位标志表示的，如下所示:

- 0：这个文件的存在不需要让用户知道 (基本上是一个“隐藏”标志)；
- 1：该记录描述了一个目录(换句话说，它是一个子目录范围)；
- 2：该文件为 **关联文件**；
- 3：如果设置了，扩展属性记录包含关于该文件格式的信息；
- 4：扩展属性记录中设置了所有者和组权限；
- 5~6：保留
- 7：如果设置了，这不是该文件的最终目录记录(对于跨越多个区段的文件，例如超过 4GB 长的文件)；

## 定位光盘上的数据

如果您使用的是路径表方法，您仍然需要了解目录记录才能找到您正在寻找的文件。基本上，您以相反的顺序搜索路径，遵循路径表中的 **父目录** 链接。一旦您找到了包含所需文件的目录，加载该目录并扫描它以获得适当的文件名。

### 从根目录递归

或者，您可以忽略路径表，只缓存主卷描述符中的根目录。然后依次加载每个目录。例如，假设路径为：`/BOOT/MYLOADER/STAGE2.BIN`

1. 将PVD(Primary Volume Descriptor)读入内存。字节 156-189 包含根目录入口；
2. 通过读取这个根目录入口中的 LBA 和 Length 值来加载根目录；
3. 扫描目录条目标识符以找到 `BOOT;1`；
4. 如果找到，使用 LBA 和 length 值将 `BOOT` 目录加载到内存中；
5. 为文件标识符 `MYLOADER;1` 重复步骤 3 和 4；
6. 扫描 `MYLOADER` 目录，找到 `STAGE2.BIN;1`。如果找到，现在可以使用 LBA 值将文件加载到内存中；

## Rock Ridge 和 Joliet

ISO 9660 有两个优化版本，使其更适合 Unix 和 MS-Windows 世界。两者都可以组合在同一个文件系统中。因此，读者通常有三种文件名空间可供选择：

- Plain ISO
- Rock Ridge
- Joliet

ISO 和 Rock Ridge 将显示相同的文件树，但名称不同。Joliet 可以显示出与 ISO 完全不同的树。

Rock Ridge 允许文件名最多为 255 个 8 位字符。只有 0 字节和斜杠("/")不能被使用。此外，它还添加了由 POSIX 指定的文件属性(所有者、组、权限等)，并允许符号链接。

Rock Ridge 是 SUSP 的一个应用。它可能伴随着其他 SUSP 应用程序，如 zisofs(数据文件压缩，特定于 Linux)， Apple ISO 9660 扩展，Amiga AS 入口，或任意属性交换协议(AAIP:扩展属性和 ACLs)。SUSP 入口的读者应该简单地忽略它不期望的所有条目类型。

Joliet 由微软公司定义，允许最多 64 UCS-2 字符(16位)的文件名。它被实现为一个单独的目录记录树，从补充卷描述符中的根记录开始。该描述符类似于主卷描述符，但其类型代码为 2。

## 参考

[^iso-9660]: <https://wiki.osdev.org/ISO_9660>
[^blu-ray]: <https://en.wikipedia.org/wiki/Blu-ray>
[^El-Torito]: <https://wiki.osdev.org/El-Torito>
[^Nero]: <https://www.nero.com/> 一个烧录软件
[^bit_numbering]: <https://en.wikipedia.org/wiki/Bit_numbering>
