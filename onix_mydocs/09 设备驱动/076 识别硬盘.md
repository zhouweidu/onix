# 识别硬盘

## 标准和非标准检测

目前所有的 BIOS 都标准化了 IDENTIFY 命令的使用，以检测所有类型的 ATA 总线设备的存在 PATA, PATAPI, SATAPI, SATA。

还有另外两种不推荐使用的非标准技术。第一个是选择一个设备(然后做 400ns 延迟)，然后读取设备的状态寄存器。对于没有 “休眠” 的ATA 设备，将始终设置 RDY 位。这应该是可检测的，只要您已经测试了浮点数(所有位总是设置)。如果没有设备，那么状态值将为 0。这种方法不适用于检测 ATAPI 设备，它们的 RDY 位总是清除的(直到它们得到第一个 PACKET 命令)。

另一种方法是使用执行设备诊断命令(0x90)。它应该在错误寄存器(主总线上的 0x1F1 )中设置位来显示总线上主设备和从设备的存在。

## IDENTIFY 命令

> 以下内容来自 osdev.org，经过测试可能不太准确；

要使用 IDENTIFY 命令：

1. 向 驱动器选择 IO 端口发送命令：
    1. 主驱动器发送 0xA0，端口 0x1F6
    2. 从驱动器发送 0xB0，端口 0x176
2. 将 扇区数量、LBA 等 IO 端口设置为 0 (端口 0x1F2 到 0x1F5) (这步可能不需要)
3. 将 IDENTIFY 命令(0xEC) 发送到命令 IO 端口(0x1F7)
4. 再次读取状态端口(0x1F7)。如果读的值为 0，则表示驱动器不存在
5. 对于任何其他值：轮询状态端口(0x1F7)，直到第7位(BSY, value = 0x80)清除
6. 由于一些 ATAPI 驱动器不符合规范，此时您需要检查 LBAmid 和 LBAhi 端口(0x1F4和0x1F5)，以查看它们是否非零。如果是这样，驱动器不是 ATA，您应该停止轮询。否则，继续轮询其中一个状态端口，直到第 3 位(DRQ，值=8)置位，或直到第 0 位(ERR，值=1)置位
7. 如果清除了 ERR，就可以从数据端口(0x1F0)读取数据了。读取 256 个 16 位值，并存储它们

## 复位驱动器/软件复位

对于非 ATAPI 驱动器，驱动器在发生重大错误后复位驱动器的唯一方法是在总线上做 **软件复位**

在适当的控制寄存器中为总线设置位 2 (SRST，值=4)。这将重置总线上的两个 ATA 设备，然后，你得自己再清除一遍。总线上的主驱动器被自动选择；

ATAPI 驱动器在它们的 LBA_LOW 和 LBA_HIGH IO 端口上设置值，但不应该重置或甚至终止它们的当前命令。

## 参考文献

- <https://wiki.osdev.org/PCI_IDE_Controller>
- Information Technology - AT Attachment - 8 ATA/ATAPI Command Set (ATA8-ACS)
- <https://wiki.osdev.org/ATA_PIO_Mode>
- <https://gcc.gnu.org/onlinedocs/cpp/Concatenation.html>
