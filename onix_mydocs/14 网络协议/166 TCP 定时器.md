# TCP 定时器

TCP 为每条连接建立了七个定时器。按照它们在一条连接生存期内出现的次序，简要介绍如下：

1. 连接建立(connection establishment)定时器：在发送 SYN 报文段建立一条新连接时启动。如果没有在 75 秒内收到响应，连接建立将中止；

2. 重传(retransmission) 定时器：在 TCP 发送数据时设定。如果定时器已超时而对端的确认还未到达，TCP 将重传数据。重传定时器的值（即 TCP 等待对端确认的时间）是动态计算的，取决于 TCP 为该连接测量的往返时间和该报文段已被重传的次数；

3. 延迟 ACK(delayed ACK) 定时器：在 TCP 收到必须被确认但不需要马上发出确认的数据时设定，TCP 等待 200ms 后发送确认响应。如果，在这 200ms 内，有数据要在该连接上发送，延迟的 `ACK` 响应就可随着数据一起发送回对端，称为捎带确认；

4. 持续(persist) 定时器：在连接对端通告接收窗口为 0, 阻止 TCP 继续发送数据时设定。由于连接对端发送的窗口通告不可靠（只有数据才会被确认， ACK 不会被确认），允许 TCP 继续发送数据的后续窗口更新有可能丢失。因此，如果 TCP 有数据要发送，但对端通告接收窗口为 0, 则持续定时器启动，超时后向对端发送 1 字节的数据，判定对端接收窗口是否已打开。与重传定时器类似，持续定时器的值也是动态计算的，取决于连接的往返时间，在 5 秒到 60 秒之间取值；

5. 保活(keepalive) 定时器：在应用进程选取了插口的 `SO_KEEPALVE` 选项时生效。如果连接的连续空闲时间超过 2 小时，保活定时器超时，向对端发送连接探测报文段，强迫对端响应。如果收到了期待的响应， TCP 可确定对端主机工作正常，在该连接再次空闲超过 2 小时之前，TCP 不会再进行保活测试。如果收到的是其他响应，TCP 可确定对端主机已重启。如果连续若干次保活测试都未收到响应，TCP 就假定对端主机已崩溃，尽管它无法区分是主机故障（例如，系统崩溃而尚未重启），还是连接故障（例如，中间的路由器发生故障或电话线断了）；

6. `FIN_WAIT2` 定时器：当某个连接从 `FIN_WAIT1` 状态变迁到 `FIN_WAIT2` 状态，并且不能再接收任何新数据时（意味着应用进程调用了 `close`, 而非 `shutdown`，没有利用 TCP 的半关闭功能），`FIN_WAIT2` 定时器启动，设为 10 分钟。定时器超时后，重新设为 75 秒，第二次超时后连接被关闭。加入这个定时器的目的是为了避免如果对端一直不发送 `FIN`，某个连接会永远滞留在 `FIN_WAIT2` 状态；

7. `TIME_WAIT` 定时器， 一般也称为 2MSL 定时器。2MSL 指两倍的 MSL, 最大报文段生存时间。当连接转移到 `TIME_WAIT` 状态，即连接主动关闭时，定时器启动；连接进入 `TIME_WAIT` 状态时，定时器设定为 1 分钟，超时后，TCP 控制块 和 PCB 被删除，端口号可重新使用；

TCP包括两个定时器函数：

- 一个函数每 200 ms 调用一次（快速定时器）；
- 一个函数每 500 ms 调用一次（慢速定时器）；

延迟 ACK 定时器与其他 6 个定时器有所不同：如果某个连接上设定了延迟 ACK 定时器，那么下一次 200 ms 定时器超时后，延迟的 ACK 必须被发送 ACK 的延迟时间必须在 0-200 ms 之间。其他的定时器每 500ms 递减一次，计数器减为 0 时，就触发相应的动作。

## 参考

- TCP/IP 详解 卷2：实现
